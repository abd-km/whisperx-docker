# Traefik-optimized values for whisperx-api
# Use with: helm install -f values.yaml -f values-traefik.yaml

## Scale for production
replicaCount: 2

## WhisperX configuration
whisperx:
  model:
    name: "large-v3"
    computeType: "float16"
    batchSize: 64

## GPU configuration
gpu:
  enabled: true
  vendor: nvidia
  count: 1
  memory: "141Gi"
  nodeSelector:
    enabled: true
    nvidia.com/gpu.product: "NVIDIA-H200-Tensor-Core-GPU"

## H200-optimized resources
resources:
  requests:
    cpu: "16"
    memory: "64Gi"
    nvidia.com/gpu: 1
  limits:
    cpu: "32"
    memory: "128Gi"
    nvidia.com/gpu: 1

## Persistent storage
persistence:
  enabled: true
  storageClass: "fast-ssd"
  accessMode: ReadWriteMany
  size: 100Gi

## Service configuration
service:
  type: ClusterIP  # Traefik handles external access
  port: 8000

## Traefik Ingress configuration
ingress:
  enabled: true
  className: "traefik"
  annotations:
    # TLS configuration
    traefik.ingress.kubernetes.io/router.tls: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # Middleware for timeouts (large audio files)
    traefik.ingress.kubernetes.io/router.middlewares: "ai-services-whisperx-timeout@kubernetescrd"
    
    # Rate limiting (optional)
    # traefik.ingress.kubernetes.io/router.middlewares: "ai-services-ratelimit@kubernetescrd"
    
    # Request size limit (100MB for audio files)
    traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
    
    # Priority (higher = more specific routes take precedence)
    traefik.ingress.kubernetes.io/router.priority: "10"
  
  hosts:
    - host: whisperx.yourdomain.com
      paths:
        - path: /
          pathType: Prefix
  
  tls:
    - secretName: whisperx-tls
      hosts:
        - whisperx.yourdomain.com

## Node selector for H200
nodeSelector:
  nvidia.com/gpu.product: "NVIDIA-H200-Tensor-Core-GPU"

## Tolerations for GPU nodes
tolerations:
  - key: "nvidia.com/gpu"
    operator: "Exists"
    effect: "NoSchedule"

## Anti-affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - whisperx-api
          topologyKey: kubernetes.io/hostname

## High priority
priorityClassName: "high-priority"

## Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

